<html lang="en">
<head>
<title>VM instruction table - Vmgen (Gforth 0.7.0)</title>
<meta http-equiv="Content-Type" content="text/html">
<meta name="description" content="Vmgen (Gforth 0.7.0)">
<meta name="generator" content="makeinfo 4.8">
<link title="Top" rel="start" href="index.html#Top">
<link rel="up" href="Using-the-generated-code.html#Using-the-generated-code" title="Using the generated code">
<link rel="prev" href="VM-engine.html#VM-engine" title="VM engine">
<link rel="next" href="VM-code-generation.html#VM-code-generation" title="VM code generation">
<link href="http://www.gnu.org/software/texinfo/" rel="generator-home" title="Texinfo Homepage">
<!--
This manual is for Vmgen
(version 0.7.0, November 2, 2008),
the virtual machine interpreter generator

Copyright (C) 2002,2003,2005,2007,2008 Free Software Foundation, Inc.

     Permission is granted to copy, distribute and/or modify this
     document under the terms of the GNU Free Documentation License,
     Version 1.2 or any later version published by the Free Software
     Foundation; with no Invariant Sections, with the Front-Cover texts
     being ``A GNU Manual,'' and with the Back-Cover Texts as in (a)
     below.  A copy of the license is included in the section entitled
     ``GNU Free Documentation License.''

     (a) The FSF's Back-Cover Text is: ``You have freedom to copy and
     modify this GNU Manual, like GNU software.  Copies published by
     the Free Software Foundation raise funds for GNU development.''
   -->
<meta http-equiv="Content-Style-Type" content="text/css">
<style type="text/css"><!--
  pre.display { font-family:inherit }
  pre.format  { font-family:inherit }
  pre.smalldisplay { font-family:inherit; font-size:smaller }
  pre.smallformat  { font-family:inherit; font-size:smaller }
  pre.smallexample { font-size:smaller }
  pre.smalllisp    { font-size:smaller }
  span.sc    { font-variant:small-caps }
  span.roman { font-family:serif; font-weight:normal; } 
  span.sansserif { font-family:sans-serif; font-weight:normal; } 
--></style>
</head>
<body>
<div class="node">
<p>
<a name="VM-instruction-table"></a>
Next:&nbsp;<a rel="next" accesskey="n" href="VM-code-generation.html#VM-code-generation">VM code generation</a>,
Previous:&nbsp;<a rel="previous" accesskey="p" href="VM-engine.html#VM-engine">VM engine</a>,
Up:&nbsp;<a rel="up" accesskey="u" href="Using-the-generated-code.html#Using-the-generated-code">Using the generated code</a>
<hr>
</div>

<h3 class="section">8.2 VM instruction table</h3>

<p><a name="index-instruction-table-162"></a><a name="index-opcode-definition-163"></a><a name="index-labels-for-threaded-code-164"></a><a name="index-g_t_0040code_007bvm_005fprim_007d_002c-definition-165"></a><a name="index-g_t_0040file_007b_002dlabels_002ei_007d-output-file-166"></a>
For threaded code we also need to produce a table containing the labels
of all VM instructions.  This is needed for VM code generation
(see <a href="VM-code-generation.html#VM-code-generation">VM code generation</a>), and it has to be done in the engine
function, because the labels are not visible outside.  It then has to be
passed outside the function (and assigned to `<samp><span class="samp">vm_prim</span></samp>'), to be used
by the VM code generation functions.

   <p>This means that the engine function has to be called first to produce
the VM instruction table, and later, after generating VM code, it has to
be called again to execute the generated VM code (yes, this is ugly). 
In our example program, these two modes of calling the engine function
are differentiated by the value of the parameter ip0 (if it equals 0,
then the table is passed out, otherwise the VM code is executed); in our
example, we pass the table out by assigning it to `<samp><span class="samp">vm_prim</span></samp>' and
returning from `<samp><span class="samp">engine</span></samp>'.

   <p>In our example (<samp><span class="file">vmgen-ex/engine.c</span></samp>), we also build such a table for
switch dispatch; this is mainly done for uniformity.

   <p>For switch dispatch, we also need to define the VM instruction opcodes
used as case labels in an <code>enum</code>.

   <p>For both purposes (VM instruction table, and enum), the file
<samp><var>name</var><span class="file">-labels.i</span></samp> is generated by Vmgen.  You have to define
the following macro used in this file:

     
<a name="index-INST_005fADDR-167"></a>
<dl><dt><code>INST_ADDR(</code><var>inst_name</var><code>)</code><dd>For switch dispatch, this is just the name of the switch label (the same
name as used in `<samp><span class="samp">LABEL(</span><var>inst_name</var><span class="samp">)</span></samp>'), for both uses of
<samp><var>name</var><span class="file">-labels.i</span></samp>.  For threaded-code dispatch, this is the
address of the label defined in `<samp><span class="samp">LABEL(</span><var>inst_name</var><span class="samp">)</span></samp>'); the
address is taken with `<samp><span class="samp">&amp;&amp;</span></samp>' (see <a href="../gcc/Labels-as-Values.html#Labels-as-Values">Labels as Values</a>).

   </dl>

<!--  -->
</body></html>

